# Application staging product-baseline install

**Table of contents:**
<!-- START doctoc
...
END doctoc -->

## Description

The product-baseline install job has been separated from the upgrade pipelines to reduce the upgrade execution time.
The job can be triggered from the product and meta upgrade jobs directly or started by time triggered cron job via eea-product-prepare-upgrade or can be started manually also.

## Jenkins job

Job name: [eea-application-staging-product-baseline-install](https://seliius27190.seli.gic.ericsson.se:8443/job/eea-application-staging-product-baseline-install/)

## Jobs calling eea-application-staging-product-baseline-install

+ [eea-product-prepare-upgrade](https://seliius27190.seli.gic.ericsson.se:8443/job/eea-product-prepare-upgrade/)

## Parameters from eea_application_staging_product_baseline_install.groovy

+ DRY_RUN - This parameter is used to rebuild the job (without running its full logic) in case of change in parameters.
+ JENKINSFILE_GERRIT_REFSPEC - Git ref in EEA/adp-app-staging repo to eea_application_staging_product_baseline_install.Jenkinsfile for fecth from master or change test from refspec. Default is ${MAIN_BRANCH}, test refspec E.g:refs/changes/62/16470962/2

## Parameters from eea_application_staging_product_baseline_install.Jenkinsfile

+ INT_CHART_NAME - Chart name e.g.: eric-ms-b
+ INT_CHART_REPO - Chart repo i.e.: [https://arm.seli.gic.ericsson.se/artifactory/proj-eea-drop-helm/]
+ GIT_BRANCH - Gerrit git branch of the integration chart git repo e.g.: eea4_4.4.0_pra . If the value is latest than calculate the branch name using the latest pra git tag
+ SPINNAKER_TRIGGER_URL - Spinnaker pipeline triggering url
+ lock_start - Locking start timestamp, will be overwritten
+ lock_end - Locking start timestamp, will be overwritten
+ SPINNAKER_ID - The spinnaker execution
+ PIPELINE_NAME - The spinnaker pipeline name
+ GERRIT_REFSPEC - Gerrit Refspec of the integration chart git repo e.g.: refs/changes/90/12941790/2
+ SKIP_META_BASELINE_INSTALL - skip the meta-baseline install stage
+ SKIP_COLLECT_LOG - skip the log collection pipeline
+ SKIP_CLEANUP - skip the cleanup pipeline.
+ CUSTOM_CLUSTER_LABEL - If CUSTOM_CLUSTER_LABEL is set, we have to set that label at the end of the pipeline executions, and FORCE skip the cleanup !!!
+ CLUSTER_LABEL - cluster resource label to execute on. Default valuse is
+ CLUSTER_NAME - cluster resource name to execute on. Don
+ BUILD_RESULT_WHEN_NELS_CHECK_FAILED - build result when the Check NELS availability failed
+ HELM_AND_CMA_VALIDATION_MODE - Use HELM values or HELM values and CMA configurations. valid options ("true":  use helm values, cma is disabled / "false": use helm values and load CMA configurations)
+ SKIP_SPOTFIRE_INSTALL - skip the Spotfire install stage

## Steps

+ Wait for cluster
  + The job will wait until we have a free bob-ci cluster
+ Lock
+ Check NELS availability
+ Check eric-eea-* namespaces not exist
  + If a namespace is found, the build will fail and an alert will be sent to the Driver channel
+ CRD install
+ Set CMA helm values
+ Run dimtool
+ Execute Spotfire deployment
  + If the SKIP_SPOTFIRE_INSTALL is true then will be skipped
+ UTF and data-loader deploy
  + If SKIP_META_BASELINE_INSTALL parameter is false we will install the latest meta-baseline.
  + Job name: [eea-product-ci-meta-baseline-loop-utf-and-data-loader-deploy](https://seliius27190.seli.gic.ericsson.se:8443/job/eea-product-ci-meta-baseline-loop-utf-and-data-loader-deploy/)
  + Job doc [link](https://eteamspace.internal.ericsson.com/display/ECISE/Information+about+eea_product_ci_meta_baseline_loop+in+Product+CI)
+ Store meta-baseline-install configmap
+ SEP install
+ Product install
  + verify-values-files bob-rule to check helm values from next lists (`values-list.txt`, `mxe-values-list.txt`). These files are passed as input parameters to the bob rule. After verification a list of helm value files are written to var.helm-values-list and var.mxe-helm-values-list bob variables accordingly and afterwards they are consumed by the downstream k8s-test-splitted-values rule
  + k8s-test-splitted-values bob-rule (`helm-values/custom_environment_values.yaml,dataflow-configuration/refdata-values.yaml,dataflow-configuration/correlator-values.yaml,dataflow-configuration/aggregator-values.yaml,dataflow-configuration/db-loader-values.yaml,dataflow-configuration/db-manager-values.yaml,dataflow-configuration/dashboard-values.yaml,helm-values/custom_dimensioning_values.yaml,helm-values/custom_deployment_values.yaml,helm-values` from the latest_release branch or specified GERRIT_REFSPEC are used for the installation)
  + archiving of the k8s-test-verify-values.log file that's generated by verify-values-files above bob-rule
  + archiving of the above helm config value files as `install-configvalues.tar.gz` using archiveFilesFromLog()
+ Link Spotfire platform to EEA
  + If the SKIP_SPOTFIRE_INSTALL is true then will be skipped
+ Create stream-aggregator configmap
+ Run health check after install
+ Load config json to CM-Analytics
  + 1 hour and 1 day related stream aggregator configurations are removed with a manual step.
+ Run health check after CM-Analytics config load
+ Run CMA health check after CM-Analytics config load
+ Store product-baseline-install configmap
+ Relabeling cluster
  + It is mandatory to set the proper label for the cluster while the cluster still locked.
  + If CUSTOM_CLUSTER_LABEL parameter is empty we will set the `bob-ci-upgrade-ready` label otherwise we will set the parameter value to the resource label.
  + If the pipeline result is not SUCCESS, then we will always set the label to `faulty`.
+ Cluster log collection
  + If SKIP_COLLECT_LOG parameter is false we will collect logs from the test environment using ADP log collector from a separated job. /wait for result: true/
  + Job name: [cluster-logcollector](https://seliius27190.seli.gic.ericsson.se:8443/job/cluster-logcollector)
  + Job doc [link](https://eteamspace.internal.ericsson.com/display/ECISE/Cluster+Log+Collector)

## Configuration

+ The product-baseline version to install can be specified with the GIT_BRANCH or GERRIT_REFSPEC parameter. Only one of these must be specified at the same time.
+ The GIT_BRANCH parameter default value is 'latest'. In this case the pipeline will calculate the branch name using the latest pra git tag: 'latest_release'. Otherwise any valid git branch can be specified from the [cnint repo](https://gerrit.ericsson.se/#/admin/projects/EEA/cnint,branches).
+ If the GERRIT_REFSPEC parameter is not empty the program will checkout that refspec and will use the version from the 'eric-eea-int-helm-chart/Chart.yaml' file to install the proper product-baseline.

## CMA related stages and steps

See page [CMA configurations in product deployments](https://eteamspace.internal.ericsson.com/display/ECISE/CMA+configurations+in+product+deployments)

## Spotfire install related documentation

See page [Cluster deploy Spotfire platform](https://eteamspace.internal.ericsson.com/display/ECISE/Cluster+deploy+Spotfire+platform)
